name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * *'  # 每天凌晨 2 点运行

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ==================== 代码质量检查 ====================
  quality-checks:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pylint black isort flake8 mypy
          pip install -r backend/requirements.txt
      
      - name: Format check (isort)
        run: isort --check-only backend/
      
      - name: Format check (black)
        run: black --check backend/
      
      - name: Lint (flake8)
        run: flake8 backend/ --max-line-length=120 --count --show-source --statistics
      
      - name: Type check (mypy)
        run: mypy backend/ --ignore-missing-imports || true
      
      - name: Security check (bandit)
        run: pip install bandit && bandit -r backend/ -ll || true

  # ==================== 后端单元测试 ====================
  backend-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install pytest pytest-cov pytest-asyncio
      
      - name: Alembic migrations dry-run (render SQL only)
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test_db
        run: |
          pip install alembic
          python tools/alembic_ci_check.py

      - name: Run tests with coverage
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379/0
        run: |
          pytest backend/tests/ \
            --cov=backend \
            --cov-report=xml \
            --cov-report=term-missing:skip-covered \
            --cov-report=html \
            --cov-fail-under=50 \
            -v --tb=short

      - name: Check coverage threshold
        run: |
          echo "Coverage report generated in htmlcov/index.html"
          coverage report --fail-under=50
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
      
      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MINIMUM_GREEN: 80
          MINIMUM_ORANGE: 50

  # ==================== 前端测试 ====================
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
      
      - name: Install dependencies
        run: cd frontend && npm ci
      
      - name: Run linter
        run: cd frontend && npm run lint || true
      
      - name: Run tests
        run: cd frontend && npm run test -- --coverage || true
      
      - name: Build
        run: cd frontend && npm run build

  # ==================== 安全扫描 ====================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install safety
          pip install -q -r backend/requirements.txt
      
      - name: Check Python dependencies for vulnerabilities
        run: safety check --json > safety-report.json || true
      
      - name: Check Node dependencies
        run: |
          cd frontend
          npm audit --json > npm-audit.json || true
      
      - name: Upload security reports
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            safety-report.json
            frontend/npm-audit.json

  # ==================== 构建容器镜像 ====================
  
  # ==================== 监控配置校验 ====================
  monitoring-checks:
    name: Monitoring Config Validation
    runs-on: ubuntu-latest
    needs: quality-checks

    steps:
      - uses: actions/checkout@v4

      - name: Download promtool
        run: |
          PROM_VERSION=${{ env.PROM_VERSION || '2.45.0' }}
          ARCH=linux-amd64
          URL="https://github.com/prometheus/prometheus/releases/download/v${PROM_VERSION}/prometheus-${PROM_VERSION}.${ARCH}.tar.gz"
          echo "Downloading promtool from $URL"
          curl -sL "$URL" -o /tmp/prom.tar.gz
          tar -xzf /tmp/prom.tar.gz -C /tmp
          ls /tmp/prometheus-${{ env.PROM_VERSION || '2.45.0' }}.${ARCH}
          sudo mv /tmp/prometheus-${{ env.PROM_VERSION || '2.45.0' }}.${ARCH}/promtool /usr/local/bin/

      - name: Validate Prometheus rules and config
        run: |
          chmod +x scripts/validate_monitoring.sh
          ./scripts/validate_monitoring.sh

  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [quality-checks, backend-tests, frontend-tests]
    permissions:
      contents: read
      packages: write
    
    if: github.event_name == 'push' || github.event_name == 'schedule'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Log in to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push backend image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./docker/Dockerfile.prod
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}-backend
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
      
      - name: Build and push frontend image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}-frontend
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==================== 部署到暂存环境 ====================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.ylai.local
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to staging
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          DEPLOY_HOST: staging.ylai.local
          DEPLOY_USER: deploy
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan $DEPLOY_HOST >> ~/.ssh/known_hosts
          
          ssh -i ~/.ssh/deploy_key $DEPLOY_USER@$DEPLOY_HOST \
            "cd /app && git pull && docker-compose up -d"
      
      - name: Health check
        run: |
          for i in {1..30}; do
            curl -f https://staging.ylai.local/api/health && exit 0
            sleep 10
          done
          exit 1

  # ==================== 部署到生产环境 ====================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    environment:
      name: production
      url: https://ylai.local
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Create deployment
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.ref,
              environment: 'production',
              required_contexts: [],
              auto_merge: false
            });
            console.log('Deployment ID:', deployment.data.id);
      
      - name: Deploy to production
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          DEPLOY_HOST: prod.ylai.local
          DEPLOY_USER: deploy
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan $DEPLOY_HOST >> ~/.ssh/known_hosts
          
          ssh -i ~/.ssh/deploy_key $DEPLOY_USER@$DEPLOY_HOST \
            "cd /app && git fetch origin && git checkout ${{ github.ref_name }} && \
             docker-compose -f docker/docker-compose.prod.yml pull && \
             docker-compose -f docker/docker-compose.prod.yml up -d && \
             docker-compose -f docker/docker-compose.prod.yml ps"
      
      - name: Smoke tests
        run: |
          for i in {1..30}; do
            curl -f https://ylai.local/api/health && exit 0
            sleep 10
          done
          exit 1
      
      - name: Performance baseline test
        run: |
          ab -n 100 -c 10 https://ylai.local/ || true
      
      - name: Update deployment status
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.deploy.outputs.deployment_id }},
              state: 'success',
              environment_url: 'https://ylai.local',
              auto_inactive: false
            });

  # ==================== 发布版本 ====================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: deploy-production
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            See CHANGELOG.md for details
          draft: false
          prerelease: false
