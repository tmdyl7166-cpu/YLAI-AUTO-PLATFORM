# 配置映射与扩展指南

**文档用途**: 完整映射所有可配置项、预留字段和扩展点  
**更新日期**: 2025-12-13  
**版本**: 1.0.0

---

## 📋 快速导航

- [1. 核心逻辑映射](#1-核心逻辑映射)
- [2. 必填字段映射表](#2-必填字段映射表)
- [3. 可选字段映射表](#3-可选字段映射表)
- [4. 系统预留扩展点](#4-系统预留扩展点)
- [5. 修改操作指南](#5-修改操作指南)

---

## 1. 核心逻辑映射

### 1.1 动态父目录识别机制

| 场景 | 条件 | 项目根目录 | 作用域 | 外部规则文件位置 |
|------|------|-----------|--------|----------------|
| **场景A**<br>本项目自身 | `.github` 无父目录 | `~/` = `.github` 本身 | 仅 `.github/` 内 | 不适用 |
| **场景B**<br>检测到父目录 | `.github` 有父目录 | 父目录/ | 父目录及所有同级内容 | 父目录下（与 `.github` 同级） |

### 1.2 规则优先级体系

| 优先级 | 规则来源 | 配置位置 | 触发条件 | 失败回退 |
|-------|---------|---------|---------|---------|
| **1** (最高) | 外部规则文件 | `gitc.md` → `external_rules_file` | 有父目录 + 配置了路径 + 验证通过 | 优先级3 |
| **2** | gitc.md 描述 | `gitc.md` 文档内容 | 优先级1未生效 | 优先级3 |
| **3** (回退) | 内置规则库 | `.github/.copilot-config.json` | 任何时候都可用 | - |

---

## 2. 必填字段映射表

### 2.1 外部规则配置

| 字段名 | 位置 | 数据类型 | 默认值 | 如何修改 | 影响范围 |
|-------|------|---------|-------|---------|---------|
| `external_rules_file` | `gitc.md` 头部 | String | `""` (空) | 填写文件名<br>如: `"YL-rules.json"` | 整个项目根目录及同级内容 |

**修改示例**:
```json
// 方式1: 不使用外部规则（推荐）
{
  "external_rules_file": ""
}

// 方式2: 使用外部规则（需在父目录下创建对应文件）
{
  "external_rules_file": "YL-project-rules.json"
}
```

**验证要求**:
- ✅ 文件名必须以 `YL` 或 `yl` 开头（大小写不敏感）
- ✅ 文件必须在父目录下（与 `.github` 同级）
- ✅ 必须是有效的 JSON 格式

---

### 2.2 项目基本信息

| 字段名 | 位置 | 占位符 | 如何修改 | 示例 |
|-------|------|--------|---------|------|
| 项目名称 | `gitc.md` → 项目概览 | `[待填写：...]` | 直接替换占位符 | `电商订单管理系统` |
| 项目类型 | `gitc.md` → 项目概览 | `[待填写：...]` | 直接替换占位符 | `Web应用（前后端分离）` |
| 主要用途 | `gitc.md` → 项目概览 | `[待填写：...]` | 直接替换占位符 | `提供订单全生命周期管理` |

**修改示例**:
```markdown
**项目名称**: 智能客服系统
**项目类型**: 微服务架构
**主要用途**: 基于AI的多渠道客户服务与工单管理
```

---

### 2.3 技术栈与架构

| 字段名 | 位置 | 占位符 | 必填 | 如何修改 | 示例 |
|-------|------|--------|------|---------|------|
| 主要语言 | `gitc.md` → 技术栈 | `[待填写：...]` | ✅ | 直接替换 | `Python 3.11` |
| 框架/库 | `gitc.md` → 技术栈 | `[待填写：...]` | ✅ | 直接替换 | `Django 4.2, Celery` |
| 数据库 | `gitc.md` → 技术栈 | `[待填写：...]` | ✅ | 直接替换 | `PostgreSQL 15, Redis` |
| 部署环境 | `gitc.md` → 技术栈 | `[待填写：...]` | ✅ | 直接替换 | `Docker, Kubernetes` |
| CI/CD | `gitc.md` → 技术栈 | `[待填写：...]` | ✅ | 直接替换 | `GitHub Actions` |

**修改示例**:
```markdown
- **主要语言**: TypeScript 5.0, Node.js 20
- **框架/库**: Next.js 14, React 18, Prisma
- **数据库**: MySQL 8.0, MongoDB 6.0
- **部署环境**: Vercel, AWS Lambda
- **CI/CD**: GitHub Actions, Vercel Deploy
```

---

### 2.4 核心模块说明

| 字段名 | 位置 | 占位符 | 最少数量 | 如何修改 | 示例 |
|-------|------|--------|---------|---------|------|
| 模块列表 | `gitc.md` → 核心模块 | `模块1`, `模块2`... | 3-5个 | 复制模板行，修改内容 | 见下方示例 |

**修改示例**:
```markdown
- **用户认证模块** (`auth/`): JWT令牌管理、权限控制、SSO集成
- **订单处理模块** (`orders/`): 订单创建、状态流转、支付对接
- **库存管理模块** (`inventory/`): 实时库存、预留机制、自动补货
- **通知中心** (`notifications/`): 邮件、短信、站内信推送
```

---

## 3. 可选字段映射表

### 3.1 自定义语言规范

| 配置项 | 位置 | 默认行为 | 如何扩展 | 优先级 |
|-------|------|---------|---------|-------|
| 语言规范覆盖 | `gitc.md` → 可选字段 | 使用内置规则 | 添加自定义规则块 | 高于内置 |

**扩展示例**:
```json
{
  "languageOverrides": {
    "python": {
      "namingConvention": "strict_snake_case",
      "maxLineLength": 100,
      "docstringStyle": "google"
    },
    "typescript": {
      "strictNullChecks": true,
      "noImplicitAny": true
    }
  }
}
```

**扩展点**:
- ✅ 覆盖默认命名规范
- ✅ 自定义代码风格
- ✅ 添加项目特定的 linting 规则

---

### 3.2 自定义路径规则

| 配置项 | 位置 | 默认行为 | 如何扩展 | 用途 |
|-------|------|---------|---------|------|
| `include` | `gitc.md` → 路径规则 | 扫描全部 | 添加路径列表 | 限制扫描范围 |
| `exclude` | `gitc.md` → 路径规则 | 排除通用目录 | 添加排除列表 | 忽略特定目录 |

**扩展示例**:
```json
{
  "paths": {
    "include": [
      "src/**",
      "lib/**",
      "packages/**/src"
    ],
    "exclude": [
      "**/tests/**",
      "**/temp/**",
      "legacy/**"
    ]
  }
}
```

**常见扩展场景**:
- ✅ Monorepo: 限制到特定 package
- ✅ 大型项目: 排除历史遗留代码
- ✅ 安全考虑: 排除敏感配置目录

---

### 3.3 自定义优化重点

| 配置项 | 位置 | 默认行为 | 如何扩展 | 示例 |
|-------|------|---------|---------|------|
| 优化优先级 | `gitc.md` → 优化重点 | 通用优化 | 添加优先级列表 | 见下方 |

**扩展示例**:
```markdown
### 优化重点（按优先级排序）

1. **性能优化**
   - 数据库查询优化（N+1问题）
   - 缓存策略（Redis使用）
   - 异步任务处理

2. **代码质量**
   - 类型安全（TypeScript严格模式）
   - 错误处理（统一异常机制）
   - 单元测试覆盖率 > 80%

3. **安全性**
   - SQL注入防护
   - XSS防护
   - 敏感数据加密
```

**扩展点**:
- ✅ 定义团队关注的重点领域
- ✅ 设置优化优先级顺序
- ✅ 添加具体的优化标准

---

### 3.4 自定义CI配置

| 配置项 | 位置 | 默认行为 | 如何扩展 | 触发时机 |
|-------|------|---------|---------|---------|
| CI Schema | `gitc.md` → CI配置 | 基础验证 | 自定义验证流程 | Git Push/PR |

**扩展示例**:
```json
{
  "ci": {
    "preValidation": {
      "runLinter": true,
      "runTypeCheck": true,
      "runSecurityScan": true
    },
    "validationSteps": [
      {
        "name": "检查命名规范",
        "command": "npm run lint:names"
      },
      {
        "name": "检查循环依赖",
        "command": "madge --circular src/"
      }
    ],
    "postValidation": {
      "generateReport": true,
      "notifyOnFailure": true
    }
  }
}
```

**扩展点**:
- ✅ 添加自定义验证步骤
- ✅ 集成第三方工具
- ✅ 配置通知机制

---

### 3.5 自定义钩子

| 钩子名称 | 触发时机 | 默认行为 | 如何扩展 | 用途 |
|---------|---------|---------|---------|------|
| `onBeforeScan` | 扫描前 | 无 | 添加钩子函数 | 预处理 |
| `onAfterOptimize` | 优化后 | 无 | 添加钩子函数 | 后处理 |
| `onError` | 发生错误时 | 记录日志 | 自定义错误处理 | 错误恢复 |

**扩展示例**:
```json
{
  "hooks": {
    "onBeforeScan": [
      {
        "name": "生成代码索引",
        "script": "scripts/build-index.sh"
      }
    ],
    "onAfterOptimize": [
      {
        "name": "更新文档",
        "script": "npm run docs:generate"
      },
      {
        "name": "提交统计",
        "script": "scripts/report-metrics.py"
      }
    ],
    "onError": [
      {
        "name": "发送告警",
        "script": "scripts/notify-slack.sh"
      }
    ]
  }
}
```

**扩展点**:
- ✅ 集成自动化工具
- ✅ 生成项目报告
- ✅ 触发外部系统

---

## 4. 系统预留扩展点

### 4.1 .copilot-config.json 扩展点

| 扩展点 | 位置 | 当前状态 | 扩展方式 | 影响 |
|-------|------|---------|---------|------|
| 语言规则 | `languageRules` | 9种语言 | 添加新语言配置 | 全局 |
| 框架检测 | `frameworkDetection` | 常见框架 | 添加框架模式 | 项目识别 |
| 扫描策略 | `scanningStrategy` | 默认策略 | 自定义扫描深度 | 性能 |
| 错误处理 | `errorHandling` | 三级分类 | 添加错误码 | 诊断 |

**扩展示例 - 添加新语言**:
```json
{
  "languageRules": {
    "rust": {
      "fileExtensions": [".rs"],
      "namingConventions": {
        "variables": "snake_case",
        "functions": "snake_case",
        "structs": "PascalCase"
      },
      "bestPractices": [
        "使用 Result<T, E> 进行错误处理",
        "避免 unwrap()，使用 ? 运算符",
        "优先使用借用而非所有权转移"
      ]
    }
  }
}
```

---

### 4.2 工作流扩展点

| 扩展点 | 文件 | 当前功能 | 扩展方式 | 示例 |
|-------|------|---------|---------|------|
| 验证步骤 | `workflows/validate-copilot-config.yml` | JSON语法 + gitc校验 | 添加新步骤 | 见下方 |
| 日志输出 | `workflows/...` | 基础日志 | 自定义格式 | 见下方 |
| 触发条件 | `workflows/...` | push/PR | 添加触发器 | 见下方 |

**扩展示例 - 添加验证步骤**:
```yaml
- name: 检查占位字段完成度
  run: |
    python3 - << 'PY'
    import re
    with open("gitc.md", 'r') as f:
        content = f.read()
    placeholders = re.findall(r'\[待填写', content)
    if len(placeholders) > 0:
        print(f"⚠️  发现 {len(placeholders)} 个未完成的占位字段")
        exit(1)
    print("✅ 所有占位字段已完成")
    PY

- name: 检查技术栈一致性
  run: |
    # 验证 gitc.md 中的技术栈与 package.json 是否一致
    python3 scripts/check-tech-stack-consistency.py
```

---

### 4.3 日志系统扩展点

| 日志类型 | 位置 | 当前格式 | 扩展方式 | 用途 |
|---------|------|---------|---------|------|
| 验证日志 | `.github/logs/validation.log` | 时间戳 + 消息 | 自定义格式 | 追踪验证历史 |
| 规则快照 | `.github/logs/calc-effective-rules.json` | JSON | 添加字段 | 调试规则计算 |
| 错误日志 | `.github/logs/error.log` | 预留 | 实现错误记录 | 故障排查 |

**扩展示例**:
```json
// calc-effective-rules.json 扩展字段
{
  "rules_source": "external",
  "external_rules_file": "YL-rules.json",
  "validation_passed": true,
  "fallback_reason": null,
  
  // 扩展字段
  "timestamp": "2025-12-13T10:30:00Z",
  "git_commit": "a1b2c3d",
  "detected_languages": ["python", "typescript"],
  "detected_frameworks": ["django", "react"],
  "scan_statistics": {
    "total_files": 1250,
    "scanned_files": 980,
    "excluded_files": 270
  }
}
```

---

## 5. 修改操作指南

### 5.1 新项目初始化流程

| 步骤 | 操作 | 文件 | 检查点 |
|------|------|------|-------|
| 1 | 阅读占位指南 | `PLACEHOLDER_GUIDE.md` | 理解每个字段用途 |
| 2 | 填写必填字段 | `gitc.md` | 使用 `PLACEHOLDER_CHECKLIST.md` |
| 3 | 决定是否使用外部规则 | `gitc.md` 头部 | 有父目录时可用 |
| 4 | （可选）添加可选配置 | `gitc.md` | 根据项目需求 |
| 5 | 验证配置 | 运行 CI | 检查 `logs/` 输出 |

---

### 5.2 修改外部规则文件

**前提条件**: 系统检测到父目录存在

| 步骤 | 操作 | 命令/文件 | 说明 |
|------|------|----------|------|
| 1 | 创建文件 | `YL-myproject.json` | 必须在父目录下 |
| 2 | 配置 gitc.md | `external_rules_file: "YL-myproject.json"` | 头部配置 |
| 3 | 编写规则 | 编辑 JSON 文件 | 参考 `.copilot-config.json` 结构 |
| 4 | 验证语法 | `python3 -m json.tool YL-myproject.json` | 确保有效 JSON |
| 5 | 测试生效 | 查看 `logs/calc-effective-rules.json` | 确认 `rules_source: "external"` |

**外部规则文件模板**:
```json
{
  "metadata": {
    "name": "我的项目规则",
    "version": "1.0.0",
    "description": "项目特定的Copilot规则"
  },
  "projectSpecific": {
    "conventions": {
      "api": "RESTful，遵循 OpenAPI 3.0",
      "database": "使用 Prisma ORM，避免原始 SQL",
      "testing": "Jest + React Testing Library"
    },
    "prohibitedPatterns": [
      "禁止使用 var 声明变量",
      "禁止在组件中直接操作 DOM"
    ],
    "requiredPatterns": [
      "所有API调用必须有错误处理",
      "所有组件必须有 PropTypes 或 TypeScript 类型"
    ]
  }
}
```

---

### 5.3 扩展语言支持

**修改文件**: `.github/.copilot-config.json`

| 步骤 | 操作 | 位置 | 示例 |
|------|------|------|------|
| 1 | 添加语言配置 | `languageRules` 节点 | 见下方 |
| 2 | 定义文件扩展名 | `fileExtensions` | `[".rs"]` |
| 3 | 配置命名规范 | `namingConventions` | `snake_case` 等 |
| 4 | 添加最佳实践 | `bestPractices` | 数组格式 |
| 5 | 测试验证 | 创建对应语言文件 | 观察 Copilot 建议 |

**完整示例**:
```json
{
  "languageRules": {
    "go": {
      "fileExtensions": [".go"],
      "namingConventions": {
        "packages": "lowercase_single_word",
        "functions": "MixedCaps",
        "variables": "mixedCaps",
        "constants": "MixedCaps"
      },
      "indentation": {
        "type": "tabs",
        "size": 1
      },
      "bestPractices": [
        "使用 defer 处理资源清理",
        "错误作为返回值的最后一个",
        "接口应该小而专注",
        "使用 context 进行取消和超时控制"
      ],
      "lintingRules": {
        "tool": "golangci-lint",
        "config": ".golangci.yml"
      }
    }
  }
}
```

---

### 5.4 自定义CI验证流程

**修改文件**: `workflows/validate-copilot-config.yml`

| 步骤 | 操作 | 位置 | 说明 |
|------|------|------|------|
| 1 | 添加新步骤 | `jobs.validate.steps` | YAML 格式 |
| 2 | 定义执行命令 | `run:` 字段 | Bash/Python 等 |
| 3 | 配置失败处理 | `continue-on-error` | true/false |
| 4 | 设置依赖关系 | `needs:` 字段 | 步骤顺序 |
| 5 | 测试工作流 | 提交触发 | 查看 Actions 页面 |

**示例 - 添加代码规范检查**:
```yaml
- name: 检查代码规范
  run: |
    # 安装依赖
    pip install flake8 black isort
    
    # 运行检查
    echo "检查 Python 代码格式..."
    black --check . || echo "⚠️ 代码格式不符合 Black 标准"
    
    echo "检查导入排序..."
    isort --check-only . || echo "⚠️ 导入排序不符合标准"
    
    echo "检查代码质量..."
    flake8 . --max-line-length=100 || echo "⚠️ 发现代码质量问题"

- name: 检查安全漏洞
  run: |
    pip install bandit safety
    bandit -r . -f json -o security-report.json
    safety check --json
```

---

### 5.5 添加自定义钩子

**修改文件**: `gitc.md` → 可选字段 → 自定义钩子

| 步骤 | 操作 | 格式 | 说明 |
|------|------|------|------|
| 1 | 创建钩子脚本 | Shell/Python | 放在 `scripts/` 目录 |
| 2 | 在 gitc.md 中声明 | JSON 格式 | 见下方示例 |
| 3 | 赋予执行权限 | `chmod +x script.sh` | Linux/Mac |
| 4 | 测试钩子 | 手动运行脚本 | 验证功能 |
| 5 | 集成到工作流 | 修改 `.yml` 文件 | 自动触发 |

**示例配置**:
```json
{
  "hooks": {
    "onBeforeScan": [
      {
        "name": "环境检查",
        "script": "./scripts/check-environment.sh",
        "continueOnError": false
      }
    ],
    "onAfterOptimize": [
      {
        "name": "生成变更日志",
        "script": "./scripts/generate-changelog.py",
        "continueOnError": true
      }
    ]
  }
}
```

**钩子脚本示例** (`scripts/check-environment.sh`):
```bash
#!/bin/bash
set -e

echo "🔍 检查环境配置..."

# 检查必需的环境变量
required_vars=("DATABASE_URL" "API_KEY" "SECRET_KEY")
for var in "${required_vars[@]}"; do
    if [ -z "${!var}" ]; then
        echo "❌ 缺少必需的环境变量: $var"
        exit 1
    fi
done

# 检查必需的工具
required_tools=("docker" "node" "npm")
for tool in "${required_tools[@]}"; do
    if ! command -v $tool &> /dev/null; then
        echo "❌ 缺少必需的工具: $tool"
        exit 1
    fi
done

echo "✅ 环境检查通过"
```

---

## 6. 快速参考表

### 6.1 文件功能映射

| 文件名 | 性质 | 可修改 | 主要内容 | 修改频率 |
|-------|------|-------|---------|---------|
| `gitc.md` | 规则文档 | ✅ 高频 | 项目描述、规则定义 | 每个项目必改 |
| `.copilot-config.json` | 规则库 | ⚠️ 谨慎 | 语言规范、框架检测 | 扩展新语言时 |
| `workflows/*.yml` | CI配置 | ✅ 按需 | 验证流程、自动化 | 自定义验证时 |
| `PLACEHOLDER_GUIDE.md` | 指南文档 | ❌ 只读 | 填写说明、示例 | 不建议修改 |
| `PLACEHOLDER_CHECKLIST.md` | 检查清单 | ❌ 只读 | 快速检查项 | 不建议修改 |

---

### 6.2 占位符快速索引

| 占位符格式 | 位置 | 意义 | 操作 |
|-----------|------|------|------|
| `[待填写：...]` | `gitc.md` 各处 | 必填字段 | 替换为实际内容 |
| `"external_rules_file": ""` | `gitc.md` 头部 | 外部规则配置 | 填写文件名或留空 |
| `<!-- 模板示例（可删除）-->` | `gitc.md` | 模板示例标记 | 部署前删除 |
| `模块1`, `模块2` | 核心模块部分 | 示例模块 | 替换为实际模块 |

---

### 6.3 常见扩展场景

| 场景 | 需要修改的文件 | 操作要点 | 参考章节 |
|------|--------------|---------|---------|
| 新项目初始化 | `gitc.md` | 填写所有必填字段 | 5.1 |
| 使用外部规则 | `gitc.md` + 创建 `YL-*.json` | 配置 + 验证 | 5.2 |
| 添加新语言支持 | `.copilot-config.json` | 扩展 `languageRules` | 5.3 |
| 自定义CI流程 | `workflows/*.yml` | 添加验证步骤 | 5.4 |
| 集成自动化工具 | `gitc.md` + `scripts/` | 配置钩子 | 5.5 |

---

## 7. 常见问题

### Q1: 如何判断是否需要使用外部规则文件？

**判断标准**:
- ✅ 需要：规则非常复杂，超过100行
- ✅ 需要：多个项目共享相同规则
- ✅ 需要：规则需要版本控制和独立维护
- ❌ 不需要：小型项目，规则简单
- ❌ 不需要：gitc.md 描述足够清晰

---

### Q2: 修改了配置，如何验证是否生效？

**验证步骤**:
```bash
# 1. 验证 JSON 语法
python3 -m json.tool .github/.copilot-config.json

# 2. 查看最终规则来源
cat .github/logs/calc-effective-rules.json

# 3. 检查字段
jq -r '.rules_source' .github/logs/calc-effective-rules.json
# 输出: "external" / "gitc+internal" / "internal_absolute"

# 4. 重新加载 VS Code
# 命令面板: Developer: Reload Window
```

---

### Q3: 占位字段必须全部填写吗？

**分类说明**:
- ✅ **必填**: 项目基本信息、技术栈、核心模块
- ⚠️ **可选**: 自定义语言规范、路径规则、优化重点、CI配置、钩子
- ℹ️ **建议**: 即使是可选字段，填写完整能提高 Copilot 理解准确度

---

### Q4: 如何删除模板示例内容？

**标记位置**:
所有模板示例都有 `<!-- 模板示例（可删除）-->` 标记

**删除方法**:
```bash
# 方法1: 手动删除（推荐）
# 搜索 "模板示例（可删除）" 并删除对应的示例块

# 方法2: 自动清理脚本
grep -n "模板示例（可删除）" gitc.md
# 根据行号手动删除
```

---

## 8. 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| 1.0.0 | 2025-12-13 | 初始版本，完整映射表 |

---

**文档维护**: 此文档应随系统升级同步更新  
**反馈渠道**: GitHub Issues / Pull Requests  
**最后更新**: 2025-12-13
