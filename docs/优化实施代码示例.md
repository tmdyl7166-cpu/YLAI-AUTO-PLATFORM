# ä¼˜åŒ–å®æ–½ä»£ç ç¤ºä¾‹

æœ¬æ–‡æ¡£æä¾›ä¼˜åŒ–å„æ–¹å‘çš„å…·ä½“ä»£ç ç¤ºä¾‹å’Œå®æ–½æ­¥éª¤ã€‚

---

## ğŸ¯ ä¼˜åŒ–æ–¹å‘ 1: å‰ç«¯é¡µé¢åŠŸèƒ½

### 1.1 é¦–é¡µä»ªè¡¨æ¿ç¤ºä¾‹

#### Step 1: åç«¯ API (dashboard.py)

```python
# backend/api/dashboard.py
from fastapi import APIRouter, Depends
from datetime import datetime, timedelta
from typing import Dict, Any

router = APIRouter(prefix="/api/dashboard")

@router.get("/summary")
async def get_dashboard_summary() -> Dict[str, Any]:
    """è·å–ä»ªè¡¨æ¿æ‘˜è¦æ•°æ®"""
    return {
        "timestamp": datetime.now().isoformat(),
        "system": {
            "running_tasks": 5,
            "total_tasks": 128,
            "api_calls_today": 45230,
            "error_rate": 0.02,  # 2%
        },
        "performance": {
            "avg_api_response_time": 145,  # ms
            "p95_response_time": 320,
            "throughput": 850,  # req/s
        },
        "resources": {
            "cpu_usage": 42.5,  # %
            "memory_usage": 65.3,  # %
            "disk_usage": 38.1,  # %
        }
    }

@router.get("/recent-tasks")
async def get_recent_tasks(limit: int = 10) -> Dict[str, Any]:
    """è·å–æœ€è¿‘çš„ä»»åŠ¡åˆ—è¡¨"""
    return {
        "tasks": [
            {
                "id": "task_001",
                "name": "æ•°æ®çˆ¬å–",
                "status": "running",  # running, completed, failed
                "progress": 75,
                "start_time": (datetime.now() - timedelta(minutes=5)).isoformat(),
                "duration": "5m 30s",
                "result_count": 150,
            },
            {
                "id": "task_002",
                "name": "æ•°æ®å¤„ç†",
                "status": "completed",
                "progress": 100,
                "start_time": (datetime.now() - timedelta(hours=1)).isoformat(),
                "duration": "45m 20s",
                "result_count": 500,
            },
        ]
    }

# åœ¨ app.py ä¸­æ³¨å†Œ
from backend.api.dashboard import router as dashboard_router
app.include_router(dashboard_router)
```

#### Step 2: å‰ç«¯é¡µé¢ (index.vue)

```vue
<template>
  <div class="dashboard">
    <!-- æ ‡é¢˜ -->
    <h1>é¦–é¡µä»ªè¡¨æ¿</h1>

    <!-- æ•°æ®å¡ç‰‡ -->
    <div class="cards-grid">
      <!-- è¿è¡Œä»»åŠ¡å¡ç‰‡ -->
      <div class="card">
        <div class="card-header">è¿è¡Œä¸­çš„ä»»åŠ¡</div>
        <div class="card-value">{{ summary.system.running_tasks }}</div>
        <div class="card-subtext">/ {{ summary.system.total_tasks }} æ€»ä»»åŠ¡</div>
        <div class="card-action">
          <button @click="navigateTo('/run')">è¿è¡Œæ–°ä»»åŠ¡</button>
        </div>
      </div>

      <!-- API è°ƒç”¨å¡ç‰‡ -->
      <div class="card">
        <div class="card-header">ä»Šæ—¥ API è°ƒç”¨</div>
        <div class="card-value">{{ formatNumber(summary.system.api_calls_today) }}</div>
        <div class="card-subtext">{{ summary.system.error_rate * 100 }}% é”™è¯¯ç‡</div>
        <div class="progress-bar">
          <div class="progress" :style="{ width: (100 - summary.system.error_rate * 100) + '%' }"></div>
        </div>
      </div>

      <!-- ç³»ç»Ÿèµ„æºå¡ç‰‡ -->
      <div class="card">
        <div class="card-header">ç³»ç»Ÿèµ„æº</div>
        <div class="resource-item">
          <span>CPU</span>
          <div class="resource-bar">
            <div class="resource-usage" :style="{ width: summary.resources.cpu_usage + '%' }"></div>
          </div>
          <span>{{ summary.resources.cpu_usage }}%</span>
        </div>
        <div class="resource-item">
          <span>å†…å­˜</span>
          <div class="resource-bar">
            <div class="resource-usage" :style="{ width: summary.resources.memory_usage + '%' }"></div>
          </div>
          <span>{{ summary.resources.memory_usage }}%</span>
        </div>
      </div>

      <!-- æ€§èƒ½å¡ç‰‡ -->
      <div class="card">
        <div class="card-header">API æ€§èƒ½</div>
        <div class="metric">
          <span>å¹³å‡å“åº”</span>
          <strong>{{ summary.performance.avg_api_response_time }}ms</strong>
        </div>
        <div class="metric">
          <span>ååé‡</span>
          <strong>{{ summary.performance.throughput }} req/s</strong>
        </div>
      </div>
    </div>

    <!-- æœ€è¿‘ä»»åŠ¡è¡¨ -->
    <div class="section">
      <h2>æœ€è¿‘ä»»åŠ¡</h2>
      <table class="task-table">
        <thead>
          <tr>
            <th>ä»»åŠ¡å</th>
            <th>çŠ¶æ€</th>
            <th>è¿›åº¦</th>
            <th>å¼€å§‹æ—¶é—´</th>
            <th>è€—æ—¶</th>
            <th>ç»“æœ</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="task in recentTasks" :key="task.id" :class="'status-' + task.status">
            <td>{{ task.name }}</td>
            <td>
              <span class="status-badge" :class="task.status">{{ task.status }}</span>
            </td>
            <td>
              <div class="progress-small">
                <div class="progress-fill" :style="{ width: task.progress + '%' }"></div>
              </div>
              {{ task.progress }}%
            </td>
            <td>{{ formatTime(task.start_time) }}</td>
            <td>{{ task.duration }}</td>
            <td>{{ task.result_count }} é¡¹</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</template>

<script>
import { ref, onMounted } from 'vue'
import { apiClient } from '@/api/client'
import { useRouter } from 'vue-router'

export default {
  name: 'IndexPage',
  setup() {
    const router = useRouter()
    const summary = ref(null)
    const recentTasks = ref([])
    const loading = ref(true)

    // è·å–ä»ªè¡¨æ¿æ•°æ®
    const fetchDashboard = async () => {
      try {
        loading.value = true
        const resp = await apiClient.getDashboardSummary()
        summary.value = resp.data
      } catch (error) {
        console.error('Failed to fetch dashboard:', error)
      } finally {
        loading.value = false
      }
    }

    // è·å–æœ€è¿‘ä»»åŠ¡
    const fetchRecentTasks = async () => {
      try {
        const resp = await apiClient.getRecentTasks(10)
        recentTasks.value = resp.data.tasks
      } catch (error) {
        console.error('Failed to fetch recent tasks:', error)
      }
    }

    // æ ¼å¼åŒ–æ•°å­—
    const formatNumber = (num) => {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M'
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K'
      return num
    }

    // æ ¼å¼åŒ–æ—¶é—´
    const formatTime = (timeStr) => {
      const date = new Date(timeStr)
      return date.toLocaleTimeString('zh-CN')
    }

    // å¯¼èˆª
    const navigateTo = (path) => {
      router.push(path)
    }

    // è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯ 10 ç§’ï¼‰
    onMounted(() => {
      fetchDashboard()
      fetchRecentTasks()
      
      const interval = setInterval(() => {
        fetchDashboard()
        fetchRecentTasks()
      }, 10000)

      return () => clearInterval(interval)
    })

    return {
      summary,
      recentTasks,
      loading,
      formatNumber,
      formatTime,
      navigateTo,
    }
  }
}
</script>

<style scoped>
.dashboard {
  padding: 20px;
}

.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 40px;
}

.card {
  background: white;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.card-header {
  font-size: 14px;
  color: #666;
  margin-bottom: 10px;
  font-weight: 600;
}

.card-value {
  font-size: 32px;
  font-weight: bold;
  color: #333;
  margin: 10px 0;
}

.card-subtext {
  font-size: 12px;
  color: #999;
}

.progress-bar {
  height: 6px;
  background: #f0f0f0;
  border-radius: 3px;
  margin: 10px 0;
  overflow: hidden;
}

.progress {
  height: 100%;
  background: linear-gradient(90deg, #4CAF50, #8BC34A);
}

.resource-item {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 8px 0;
  font-size: 12px;
}

.resource-bar {
  flex: 1;
  height: 6px;
  background: #f0f0f0;
  border-radius: 3px;
  overflow: hidden;
}

.resource-usage {
  height: 100%;
  background: #2196F3;
}

.metric {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  font-size: 13px;
  border-top: 1px solid #f0f0f0;
}

.metric strong {
  color: #2196F3;
}

.card-action {
  margin-top: 15px;
}

.card-action button {
  width: 100%;
  padding: 8px;
  background: #2196F3;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}

.card-action button:hover {
  background: #1976D2;
}

.section {
  margin-top: 40px;
}

.task-table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}

.task-table thead {
  background: #f5f5f5;
  border-bottom: 2px solid #e0e0e0;
}

.task-table th {
  padding: 12px;
  text-align: left;
  font-weight: 600;
  font-size: 13px;
  color: #333;
}

.task-table td {
  padding: 12px;
  border-bottom: 1px solid #f0f0f0;
  font-size: 13px;
}

.status-badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
}

.status-badge.running {
  background: #E3F2FD;
  color: #1976D2;
}

.status-badge.completed {
  background: #E8F5E9;
  color: #388E3C;
}

.status-badge.failed {
  background: #FFEBEE;
  color: #D32F2F;
}

.progress-small {
  height: 4px;
  background: #f0f0f0;
  border-radius: 2px;
  overflow: hidden;
  display: inline-block;
  width: 60px;
  margin-right: 8px;
}

.progress-fill {
  height: 100%;
  background: #2196F3;
}
</style>
```

#### Step 3: æ›´æ–° API å®¢æˆ·ç«¯

```javascript
// frontend/src/api/client.js ä¸­æ·»åŠ æ–°æ–¹æ³•
export const apiClient = {
  // ... ç°æœ‰æ–¹æ³•

  // ä»ªè¡¨æ¿
  async getDashboardSummary() {
    return this.client.get('/dashboard/summary')
  },

  async getRecentTasks(limit = 10) {
    return this.client.get('/dashboard/recent-tasks', { params: { limit } })
  },
}
```

---

### 1.2 è¿è¡Œé¡µé¢å‚æ•°è¡¨å•ç¤ºä¾‹

#### Step 1: åŠ¨æ€è¡¨å•ç»„ä»¶ (frontend/src/components/DynamicForm.vue)

```vue
<template>
  <form @submit.prevent="handleSubmit" class="dynamic-form">
    <div v-for="field in fields" :key="field.name" class="form-group">
      <label :for="field.name">{{ field.label }}</label>
      
      <!-- æ–‡æœ¬è¾“å…¥ -->
      <input
        v-if="field.type === 'text' || field.type === 'email' || field.type === 'url'"
        :id="field.name"
        v-model="formData[field.name]"
        :type="field.type"
        :placeholder="field.placeholder"
        :required="field.required"
        class="form-input"
      />
      
      <!-- æ•°å­—è¾“å…¥ -->
      <input
        v-else-if="field.type === 'number'"
        :id="field.name"
        v-model.number="formData[field.name]"
        type="number"
        :min="field.min"
        :max="field.max"
        :step="field.step"
        :required="field.required"
        class="form-input"
      />
      
      <!-- ä¸‹æ‹‰é€‰æ‹© -->
      <select
        v-else-if="field.type === 'select'"
        :id="field.name"
        v-model="formData[field.name]"
        :required="field.required"
        class="form-select"
      >
        <option value="">-- è¯·é€‰æ‹© --</option>
        <option v-for="option in field.options" :key="option.value" :value="option.value">
          {{ option.label }}
        </option>
      </select>
      
      <!-- å¤é€‰æ¡† -->
      <label v-else-if="field.type === 'checkbox'" class="checkbox-label">
        <input
          :id="field.name"
          v-model="formData[field.name]"
          type="checkbox"
        />
        {{ field.label }}
      </label>
      
      <!-- æ–‡æœ¬åŒºåŸŸ -->
      <textarea
        v-else-if="field.type === 'textarea'"
        :id="field.name"
        v-model="formData[field.name]"
        :placeholder="field.placeholder"
        :rows="field.rows || 4"
        :required="field.required"
        class="form-textarea"
      />
      
      <!-- éªŒè¯é”™è¯¯æç¤º -->
      <span v-if="errors[field.name]" class="error-message">
        {{ errors[field.name] }}
      </span>
      
      <!-- å¸®åŠ©æ–‡æœ¬ -->
      <span v-if="field.help" class="help-text">{{ field.help }}</span>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary" :disabled="loading">
        {{ loading ? 'æäº¤ä¸­...' : 'æäº¤' }}
      </button>
      <button type="reset" class="btn btn-secondary">é‡ç½®</button>
    </div>
  </form>
</template>

<script>
import { ref, computed } from 'vue'

export default {
  name: 'DynamicForm',
  props: {
    fields: {
      type: Array,
      required: true,
      // ç¤ºä¾‹:
      // [
      //   {
      //     name: 'url',
      //     label: 'ç›®æ ‡URL',
      //     type: 'url',
      //     placeholder: 'https://example.com',
      //     required: true,
      //   },
      //   {
      //     name: 'depth',
      //     label: 'çˆ¬å–æ·±åº¦',
      //     type: 'number',
      //     min: 1,
      //     max: 10,
      //     default: 3,
      //   },
      //   {
      //     name: 'format',
      //     label: 'è¾“å‡ºæ ¼å¼',
      //     type: 'select',
      //     options: [
      //       { value: 'json', label: 'JSON' },
      //       { value: 'csv', label: 'CSV' },
      //     ],
      //     default: 'json',
      //   },
      // ]
    },
    loading: {
      type: Boolean,
      default: false,
    },
  },
  emits: ['submit'],
  setup(props, { emit }) {
    const formData = ref({})
    const errors = ref({})

    // åˆå§‹åŒ–è¡¨å•æ•°æ®
    props.fields.forEach(field => {
      formData.value[field.name] = field.default || ''
    })

    const handleSubmit = async () => {
      // ç®€å•éªŒè¯
      errors.value = {}
      let hasErrors = false

      props.fields.forEach(field => {
        if (field.required && !formData.value[field.name]) {
          errors.value[field.name] = `${field.label}æ˜¯å¿…å¡«é¡¹`
          hasErrors = true
        }
      })

      if (!hasErrors) {
        emit('submit', formData.value)
      }
    }

    return {
      formData,
      errors,
      handleSubmit,
    }
  },
}
</script>

<style scoped>
.dynamic-form {
  background: white;
  padding: 20px;
  border-radius: 8px;
}

.form-group {
  margin-bottom: 20px;
  display: flex;
  flex-direction: column;
}

label {
  font-weight: 600;
  margin-bottom: 6px;
  font-size: 14px;
  color: #333;
}

.form-input,
.form-select,
.form-textarea {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 13px;
  font-family: inherit;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
  outline: none;
  border-color: #2196F3;
  box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
}

.checkbox-label {
  display: flex;
  align-items: center;
  font-weight: 400;
}

.checkbox-label input {
  margin-right: 8px;
}

.error-message {
  color: #d32f2f;
  font-size: 12px;
  margin-top: 4px;
}

.help-text {
  color: #999;
  font-size: 12px;
  margin-top: 4px;
}

.form-actions {
  display: flex;
  gap: 10px;
  margin-top: 30px;
}

.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  font-size: 13px;
  cursor: pointer;
  font-weight: 600;
}

.btn-primary {
  background: #2196F3;
  color: white;
}

.btn-primary:hover:not(:disabled) {
  background: #1976D2;
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn-secondary {
  background: #f5f5f5;
  color: #333;
  border: 1px solid #ddd;
}

.btn-secondary:hover {
  background: #efefef;
}
</style>
```

#### Step 2: åœ¨è¿è¡Œé¡µé¢ä½¿ç”¨

```vue
<template>
  <div class="run-page">
    <h1>è¿è¡Œä»»åŠ¡</h1>

    <div class="container">
      <div class="left-panel">
        <h2>å‚æ•°é…ç½®</h2>
        <DynamicForm
          :fields="taskFields"
          :loading="submitting"
          @submit="handleSubmit"
        />
      </div>

      <div class="right-panel">
        <h2>æ‰§è¡Œæ—¥å¿—</h2>
        <div class="logs">
          <div v-if="!taskRunning" class="empty-logs">
            <p>ç­‰å¾…ä»»åŠ¡æ‰§è¡Œ...</p>
          </div>
          <div v-else class="log-list">
            <div v-for="(log, index) in logs" :key="index" class="log-entry" :class="log.level">
              <span class="timestamp">{{ log.timestamp }}</span>
              <span class="level">{{ log.level }}</span>
              <span class="message">{{ log.message }}</span>
            </div>
          </div>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div v-if="taskRunning" class="progress-section">
          <div class="progress-bar-large">
            <div class="progress-fill" :style="{ width: taskProgress + '%' }"></div>
          </div>
          <p>{{ taskProgress }}% å®Œæˆ</p>
        </div>

        <!-- ç»“æœå±•ç¤º -->
        <div v-if="taskCompleted" class="result-section">
          <h3>æ‰§è¡Œç»“æœ</h3>
          <pre><code>{{ JSON.stringify(taskResult, null, 2) }}</code></pre>
          <button @click="exportResult">å¯¼å‡ºç»“æœ</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { ref } from 'vue'
import DynamicForm from '@/components/DynamicForm.vue'
import { apiClient } from '@/api/client'

export default {
  name: 'RunPage',
  components: { DynamicForm },
  setup() {
    const taskFields = ref([
      {
        name: 'script',
        label: 'é€‰æ‹©è„šæœ¬',
        type: 'select',
        options: [
          { value: 'crawl_data', label: 'æ•°æ®çˆ¬å–' },
          { value: 'process_data', label: 'æ•°æ®å¤„ç†' },
          { value: 'train_model', label: 'AIè®­ç»ƒ' },
        ],
        required: true,
      },
      {
        name: 'url',
        label: 'ç›®æ ‡URL',
        type: 'url',
        placeholder: 'https://example.com',
      },
      {
        name: 'depth',
        label: 'çˆ¬å–æ·±åº¦',
        type: 'number',
        min: 1,
        max: 10,
        default: 3,
      },
      {
        name: 'timeout',
        label: 'è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰',
        type: 'number',
        min: 10,
        max: 3600,
        default: 300,
      },
      {
        name: 'format',
        label: 'è¾“å‡ºæ ¼å¼',
        type: 'select',
        options: [
          { value: 'json', label: 'JSON' },
          { value: 'csv', label: 'CSV' },
        ],
        default: 'json',
      },
    ])

    const submitting = ref(false)
    const taskRunning = ref(false)
    const taskCompleted = ref(false)
    const taskProgress = ref(0)
    const logs = ref([])
    const taskResult = ref(null)

    const handleSubmit = async (formData) => {
      submitting.value = true
      taskRunning.value = true
      logs.value = []
      taskProgress.value = 0

      try {
        // æ‰§è¡Œä»»åŠ¡
        const response = await apiClient.runScript(formData)
        const taskId = response.data.task_id

        // ç›‘å¬æ—¥å¿—ï¼ˆä½¿ç”¨ SSE æˆ– WebSocketï¼‰
        const eventSource = new EventSource(`/api/tasks/${taskId}/logs?stream=true`)
        eventSource.onmessage = (event) => {
          const log = JSON.parse(event.data)
          logs.value.push({
            timestamp: new Date().toLocaleTimeString(),
            level: log.level || 'INFO',
            message: log.message,
          })
          taskProgress.value = log.progress || taskProgress.value
        }

        eventSource.onerror = () => {
          eventSource.close()
          taskRunning.value = false
          taskCompleted.value = true
          taskProgress.value = 100
        }
      } catch (error) {
        console.error('Task execution failed:', error)
        logs.value.push({
          timestamp: new Date().toLocaleTimeString(),
          level: 'ERROR',
          message: error.message,
        })
        taskRunning.value = false
      } finally {
        submitting.value = false
      }
    }

    const exportResult = () => {
      const data = JSON.stringify(taskResult.value, null, 2)
      const blob = new Blob([data], { type: 'application/json' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `result_${Date.now()}.json`
      a.click()
    }

    return {
      taskFields,
      submitting,
      taskRunning,
      taskCompleted,
      taskProgress,
      logs,
      taskResult,
      handleSubmit,
      exportResult,
    }
  },
}
</script>

<style scoped>
.run-page {
  padding: 20px;
}

.container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.left-panel,
.right-panel {
  background: white;
  border-radius: 8px;
  padding: 20px;
}

h2 {
  margin-bottom: 15px;
}

.logs {
  background: #f5f5f5;
  border: 1px solid #ddd;
  border-radius: 4px;
  height: 400px;
  overflow-y: auto;
  padding: 10px;
  font-family: 'Courier New', monospace;
  font-size: 12px;
}

.empty-logs {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #999;
}

.log-list {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.log-entry {
  padding: 4px 8px;
  border-radius: 2px;
  display: flex;
  gap: 10px;
}

.log-entry.DEBUG {
  background: #f0f0f0;
  color: #666;
}

.log-entry.INFO {
  background: #e3f2fd;
  color: #1976d2;
}

.log-entry.WARNING {
  background: #fff3e0;
  color: #f57c00;
}

.log-entry.ERROR {
  background: #ffebee;
  color: #d32f2f;
}

.timestamp {
  color: #999;
  font-weight: 600;
  min-width: 70px;
}

.level {
  font-weight: 600;
  min-width: 50px;
}

.progress-section {
  margin-top: 20px;
}

.progress-bar-large {
  height: 20px;
  background: #f0f0f0;
  border-radius: 4px;
  overflow: hidden;
  margin: 10px 0;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #4CAF50, #8BC34A);
  transition: width 0.3s ease;
}

.result-section {
  margin-top: 20px;
  padding: 10px;
  background: #f9f9f9;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.result-section pre {
  background: white;
  padding: 10px;
  border-radius: 4px;
  overflow-x: auto;
  max-height: 200px;
  font-size: 12px;
}

.result-section button {
  margin-top: 10px;
  padding: 8px 16px;
  background: #2196F3;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

@media (max-width: 900px) {
  .container {
    grid-template-columns: 1fr;
  }
}
</style>
```

---

## ğŸ¯ ä¼˜åŒ–æ–¹å‘ 2: åç«¯ API å®ç°

### 2.1 ä»»åŠ¡ç®¡ç† API ç¤ºä¾‹

```python
# backend/api/tasks_router.py (å®Œæ•´ç‰ˆæœ¬)
from fastapi import APIRouter, Depends, HTTPException, Query
from pydantic import BaseModel
from typing import List, Optional
from datetime import datetime
from backend.core.task import Task
from backend.api.auth import require_perm

router = APIRouter(prefix="/api/tasks", tags=["tasks"])

# ===== Pydantic æ¨¡å‹ =====
class TaskCreate(BaseModel):
    name: str
    script_id: str
    parameters: dict = {}
    timeout: int = 300

class TaskUpdate(BaseModel):
    name: Optional[str] = None
    parameters: Optional[dict] = None

class TaskResponse(BaseModel):
    id: str
    name: str
    script_id: str
    status: str  # pending, running, completed, failed
    parameters: dict
    result: Optional[dict] = None
    error: Optional[str] = None
    start_time: Optional[str] = None
    end_time: Optional[str] = None
    duration: Optional[int] = None  # seconds
    created_at: str
    created_by: str

# ===== API ç«¯ç‚¹ =====

@router.get("", response_model=dict)
async def list_tasks(
    skip: int = Query(0, ge=0),
    limit: int = Query(10, ge=1, le=100),
    status: Optional[str] = None,
    created_by: Optional[str] = None,
) -> dict:
    """
    ä»»åŠ¡åˆ—è¡¨ï¼ˆåˆ†é¡µã€ç­›é€‰ï¼‰
    
    å‚æ•°:
    - skip: è·³è¿‡çš„è®°å½•æ•°ï¼ˆåˆ†é¡µï¼‰
    - limit: è¿”å›çš„æœ€å¤§è®°å½•æ•°
    - status: ç­›é€‰çŠ¶æ€ï¼ˆpending/running/completed/failedï¼‰
    - created_by: ç­›é€‰åˆ›å»ºè€…
    """
    # TODO: ä»æ•°æ®åº“æŸ¥è¯¢
    tasks = [
        {
            "id": "task_001",
            "name": "çˆ¬å–ä»»åŠ¡",
            "status": "completed",
            "created_at": "2025-12-23T10:00:00Z",
            "created_by": "admin",
        }
    ]
    
    return {
        "total": len(tasks),
        "skip": skip,
        "limit": limit,
        "items": tasks[skip:skip+limit]
    }

@router.post("", response_model=TaskResponse)
async def create_task(task: TaskCreate) -> TaskResponse:
    """åˆ›å»ºæ–°ä»»åŠ¡"""
    task_id = f"task_{datetime.now().timestamp()}"
    
    # TODO: ä¿å­˜åˆ°æ•°æ®åº“
    
    return TaskResponse(
        id=task_id,
        name=task.name,
        script_id=task.script_id,
        parameters=task.parameters,
        status="pending",
        created_at=datetime.now().isoformat(),
        created_by="current_user",
    )

@router.get("/{task_id}", response_model=TaskResponse)
async def get_task(task_id: str) -> TaskResponse:
    """è·å–ä»»åŠ¡è¯¦æƒ…"""
    # TODO: ä»æ•°æ®åº“æŸ¥è¯¢
    raise HTTPException(status_code=404, detail="Task not found")

@router.patch("/{task_id}", response_model=TaskResponse)
async def update_task(task_id: str, task: TaskUpdate) -> TaskResponse:
    """æ›´æ–°ä»»åŠ¡"""
    # TODO: æ›´æ–°æ•°æ®åº“
    raise HTTPException(status_code=404, detail="Task not found")

@router.delete("/{task_id}")
async def delete_task(task_id: str) -> dict:
    """åˆ é™¤ä»»åŠ¡"""
    # TODO: ä»æ•°æ®åº“åˆ é™¤
    return {"message": "Task deleted"}

@router.post("/{task_id}/run")
async def run_task(task_id: str) -> dict:
    """æ‰§è¡Œä»»åŠ¡"""
    # TODO: å‘é€åˆ°é˜Ÿåˆ—æˆ–ç›´æ¥æ‰§è¡Œ
    return {
        "task_id": task_id,
        "status": "running",
        "message": "Task started"
    }

@router.post("/{task_id}/stop")
async def stop_task(task_id: str) -> dict:
    """åœæ­¢ä»»åŠ¡"""
    # TODO: åœæ­¢æ‰§è¡Œ
    return {
        "task_id": task_id,
        "status": "stopped",
        "message": "Task stopped"
    }

@router.get("/{task_id}/logs")
async def get_task_logs(task_id: str, stream: bool = False) -> dict:
    """è·å–ä»»åŠ¡æ—¥å¿—"""
    if stream:
        # è¿”å› SSE æµ
        async def log_generator():
            yield 'data: {"level": "INFO", "message": "Task started"}\n\n'
            # TODO: ä»æ—¥å¿—æœåŠ¡æµå¼è¿”å›
        return StreamingResponse(log_generator())
    
    # è¿”å›å…¨é‡æ—¥å¿—
    return {
        "task_id": task_id,
        "logs": [
            {"timestamp": "2025-12-23T10:00:00Z", "level": "INFO", "message": "Task started"},
        ]
    }
```

---

## ğŸ¯ ä¼˜åŒ–æ–¹å‘ 3: åç«¯åŸºç¡€è®¾æ–½

### 3.1 PostgreSQL é›†æˆç¤ºä¾‹

```python
# backend/core/database.py
from sqlalchemy import create_engine, Column, String, DateTime, JSON, Integer
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker, Session
from datetime import datetime
import os

# æ•°æ®åº“é…ç½®
DATABASE_URL = os.getenv("DATABASE_URL", "postgresql://user:password@localhost/ylai")

engine = create_engine(DATABASE_URL, pool_pre_ping=True)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()

# ä¾èµ–æ³¨å…¥
def get_db() -> Session:
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# ===== æ•°æ®æ¨¡å‹ =====
class TaskModel(Base):
    __tablename__ = "tasks"
    
    id = Column(String(50), primary_key=True)
    name = Column(String(255), nullable=False)
    script_id = Column(String(50), nullable=False)
    status = Column(String(20), default="pending")  # pending, running, completed, failed
    parameters = Column(JSON, default={})
    result = Column(JSON, nullable=True)
    error = Column(String(500), nullable=True)
    start_time = Column(DateTime, nullable=True)
    end_time = Column(DateTime, nullable=True)
    duration = Column(Integer, nullable=True)  # seconds
    created_at = Column(DateTime, default=datetime.utcnow)
    created_by = Column(String(50), nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

class ScriptModel(Base):
    __tablename__ = "scripts"
    
    id = Column(String(50), primary_key=True)
    name = Column(String(255), nullable=False)
    description = Column(String(500))
    content = Column(String, nullable=False)  # è„šæœ¬å†…å®¹
    parameters = Column(JSON, default={})  # å‚æ•°å®šä¹‰
    created_at = Column(DateTime, default=datetime.utcnow)
    created_by = Column(String(50), nullable=False)

# åˆ›å»ºè¡¨
Base.metadata.create_all(bind=engine)
```

### 3.2 ä»»åŠ¡ API ä½¿ç”¨æ•°æ®åº“

```python
# backend/api/tasks_router.py (æ•°æ®åº“ç‰ˆæœ¬)
from fastapi import Depends
from sqlalchemy.orm import Session
from backend.core.database import get_db, TaskModel
from datetime import datetime

@router.get("", response_model=dict)
async def list_tasks(
    skip: int = 0,
    limit: int = 10,
    status: Optional[str] = None,
    db: Session = Depends(get_db),
) -> dict:
    """ä»»åŠ¡åˆ—è¡¨ï¼ˆä»æ•°æ®åº“æŸ¥è¯¢ï¼‰"""
    query = db.query(TaskModel)
    
    if status:
        query = query.filter(TaskModel.status == status)
    
    total = query.count()
    items = query.offset(skip).limit(limit).all()
    
    return {
        "total": total,
        "skip": skip,
        "limit": limit,
        "items": [
            {
                "id": task.id,
                "name": task.name,
                "status": task.status,
                "created_at": task.created_at.isoformat(),
                "created_by": task.created_by,
            }
            for task in items
        ]
    }

@router.post("", response_model=TaskResponse)
async def create_task(
    task: TaskCreate,
    db: Session = Depends(get_db),
) -> TaskResponse:
    """åˆ›å»ºä»»åŠ¡"""
    task_id = f"task_{int(datetime.utcnow().timestamp() * 1000)}"
    
    db_task = TaskModel(
        id=task_id,
        name=task.name,
        script_id=task.script_id,
        parameters=task.parameters,
        created_by="current_user",  # TODO: ä» token è·å–
    )
    
    db.add(db_task)
    db.commit()
    db.refresh(db_task)
    
    return TaskResponse(
        id=db_task.id,
        name=db_task.name,
        script_id=db_task.script_id,
        status=db_task.status,
        parameters=db_task.parameters,
        created_at=db_task.created_at.isoformat(),
        created_by=db_task.created_by,
    )
```

---

## æ€»ç»“

ä»¥ä¸Šç¤ºä¾‹æ¶µç›–äº†ä¼˜åŒ–çš„ä¸»è¦æ–¹å‘ï¼š
1. **å‰ç«¯é¡µé¢**: ä»ªè¡¨æ¿ã€å‚æ•°è¡¨å•
2. **åç«¯ API**: ä»»åŠ¡ç®¡ç† CRUD
3. **æ•°æ®åº“**: PostgreSQL é›†æˆ

æ¯ä¸ªç¤ºä¾‹éƒ½å¯ä»¥ç‹¬ç«‹è¿è¡Œå’Œæµ‹è¯•ã€‚å»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºå®æ–½ï¼š

1. å…ˆåšåç«¯æ•°æ®åº“ï¼ˆ3-5 å¤©ï¼‰
2. å†åšåç«¯ APIï¼ˆ5-7 å¤©ï¼‰
3. æœ€ååšå‰ç«¯é¡µé¢ï¼ˆ7-10 å¤©ï¼‰

è¿™æ ·å¯ä»¥å¿«é€ŸéªŒè¯æ¶æ„å¹¶è·å¾—åé¦ˆã€‚

---

**æ–‡æ¡£å®Œæˆæ—¥æœŸ**: 2025-12-23
