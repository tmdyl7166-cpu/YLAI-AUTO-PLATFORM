# 快速启动指南

## 🚀 启动后端服务

```bash
cd /home/xiedaima/桌面/OOO/YLAI-AUTO-PLATFORM

# 激活虚拟环境
. .venv/bin/activate

# 启动 FastAPI 应用（开发模式，自动重载）
python -m uvicorn backend.app:app --reload

# 或使用任务启动（支持自动重新加载）
# 在 VS Code 任务菜单中选择: "Backend: Start with Auto-Reload"
```

## 🌐 访问应用

| 服务 | 地址 | 说明 |
|------|------|------|
| **Swagger UI** | http://localhost:8001/docs | 交互式 API 文档 |
| **ReDoc** | http://localhost:8001/redoc | 静态 API 文档 |
| **健康检查** | http://localhost:8001/health | 服务健康状态 |
| **指标** | http://localhost:8001/api/monitor/metrics | Prometheus 指标 |

## ✅ 验证集成成功

```bash
# 运行验证脚本
python scripts/verify_router_integration.py

# 预期输出:
# ✅ 导入完整性 —— 通过
# ✅ Python 语法 —— 通过  
# ✅ 代码统计 —— 通过
# ✅ Router 功能 —— 通过
# 总体结果: 4/4 项通过
```

## 📋 路由注册概览

### 主路由（11 个）

| # | 路由名称 | 前缀 | 模块 |
|---|---------|------|------|
| 1 | auth | `/auth` | backend.api.auth |
| 2 | base | `/api` | backend.api.base_router |
| 3 | pipeline | `/api/pipeline` | backend.api.pipeline |
| 4 | tasks | `/api/tasks` | backend.api.tasks_router |
| 5 | monitor | `/api/monitor` | backend.api.monitor |
| 6 | dashboard | `/api/dashboard` | backend.api.dashboard |
| 7 | policy | `/api/policy` | backend.api.policy |
| 8 | security | `/api/security` | backend.api.security |
| 9 | plugins | `/api/plugins` | backend.api.plugins |
| 10 | ai_optimize | `/api/ai` | backend.api.ai_optimize |
| 11 | generated | `/api/generated` | backend.api.generated |

### 可选路由（2 个）

| # | 路由名称 | 前缀 | 模块 | 默认 |
|---|---------|------|------|------|
| 1 | demo | `/demo` | backend.api.demo_router | ✅ 启用 |
| 2 | phone | `/api/phone` | backend.api.phone_router | ✅ 启用 |

## 🔧 常见操作

### 查看路由详情

```python
from backend.api.router_registry import get_router_info

# 获取所有路由信息
info = get_router_info()
for route in info:
    print(f"{route['name']}: {route['prefix']}")
```

### 禁用某个路由

```python
from backend.api.router_registry import ROUTER_REGISTRY, register_routers
from fastapi import FastAPI

app = FastAPI()

# 方式 1: 禁用后重新注册
ROUTER_REGISTRY['demo']['enabled'] = False
register_routers(app, include_optional=True)

# 方式 2: 在环境变量中控制（推荐用于生产）
import os
if os.getenv('DISABLE_DEMO') == 'true':
    ROUTER_REGISTRY['demo']['enabled'] = False
```

### 添加新路由

1. 在 `backend/api/` 中创建新的路由模块：
   ```bash
   touch backend/api/my_router.py
   ```

2. 在路由文件中定义 `router` 对象：
   ```python
   from fastapi import APIRouter
   router = APIRouter(prefix="/api/my", tags=["my"])
   
   @router.get("/test")
   def test():
       return {"status": "ok"}
   ```

3. 在 `backend/api/router_registry.py` 的 `ROUTER_REGISTRY` 中添加：
   ```python
   ROUTER_REGISTRY = {
       # ... 现有路由
       'my': {
           'module': 'backend.api.my_router',
           'enabled': True,
       },
   }
   ```

4. 重启应用，新路由自动注册 ✅

## 🐛 故障排除

### 问题：某个路由未显示在 Swagger UI 中

**解决步骤**:
1. 检查应用日志输出是否有错误信息
2. 运行验证脚本: `python scripts/verify_router_integration.py`
3. 检查路由模块是否存在和有效
4. 重启应用

### 问题：ImportError - 模块未找到

```
ModuleNotFoundError: No module named 'backend.api.xxx_router'
```

**解决**:
```bash
# 1. 检查文件是否存在
ls backend/api/xxx_router.py

# 2. 检查模块语法
python -m py_compile backend/api/xxx_router.py

# 3. 重启应用
```

### 问题：模块导入但路由未注册

**检查清单**:
- [ ] router_registry.py 中是否添加了该路由的定义
- [ ] 路由文件中是否定义了 `router` 对象
- [ ] router 的前缀和路径是否正确
- [ ] 是否在 ROUTER_REGISTRY 中将 `enabled` 设为 `True`

## 📊 监控路由状态

```bash
# 查看注册结果（在应用启动时打印）
python -m uvicorn backend.app:app 2>&1 | grep -E "✅|⚠️|⏭️"

# 预期输出:
# ✅ Registered 13 routers: auth, base, pipeline, tasks, monitor, ...
# ✅ Registered 0 failed routers
# ⏭️ Skipped 0 optional routers
```

## 📚 相关文档

- [集成完成报告](./集成完成报告.md) — 详细的集成说明和改进分析
- [第二梯队集成总结](./第二梯队集成总结.md) — 技术文档和实施细节
- [第一梯队优化执行总结](./第一梯队优化执行总结.md) — 前期优化成果

## ✨ 最后提示

✅ 所有路由已通过验证，可以安全投入使用  
✅ 新增路由只需在 router_registry.py 中声明  
✅ 可选路由支持动态启用/禁用  
✅ 完整的错误日志便于故障排查  

**准备好了？启动应用试试吧！** 🚀

