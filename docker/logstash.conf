input {
  # 从应用日志文件读取 JSON 格式日志
  file {
    path => "/var/log/ylai/app.log"
    start_position => "beginning"
    codec => json
    tags => ["backend", "app"]
  }
  
  # 错误日志
  file {
    path => "/var/log/ylai/error.log"
    start_position => "beginning"
    codec => json
    tags => ["backend", "error"]
  }
  
  # 性能日志
  file {
    path => "/var/log/ylai/performance.log"
    start_position => "beginning"
    codec => json
    tags => ["backend", "performance"]
  }
}

filter {
  # 解析 JSON 格式日志（如果需要额外处理）
  if [type] == "performance" {
    # 添加性能分析字段
    mutate {
      add_field => {
        "performance_tier" => "normal"
      }
    }
    
    # 标记慢查询（>1000ms）
    if [duration_ms] > 1000 {
      mutate {
        replace => {
          "performance_tier" => "slow"
        }
        add_tag => ["slow_request"]
      }
    }
    
    # 标记超慢查询（>5000ms）
    if [duration_ms] > 5000 {
      mutate {
        replace => {
          "performance_tier" => "very_slow"
        }
        add_tag => ["very_slow_request"]
      }
    }
  }
  
  # 错误分类
  if [level] == "ERROR" or [level] == "CRITICAL" {
    mutate {
      add_tag => ["error_alert"]
    }
  }
  
  # 添加环境标签
  mutate {
    add_field => {
      "environment" => "production"
      "service" => "ylai-platform"
    }
  }
}

output {
  # 发送到 Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "ylai-logs-%{+YYYY.MM.dd}"
  }
  
  # 调试输出（可选）
  # stdout { codec => rubydebug }
  
  # 慢查询告警
  if "slow_request" in [tags] {
    stdout {
      message => "[SLOW REQUEST ALERT] %{method} %{endpoint} took %{duration_ms}ms"
    }
  }
}
