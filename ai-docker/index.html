<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  <title>AI å¤šæ¨¡å‹æ¨ç†å¹³å°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --primary:#0078d7; --primary-dark:#005fa3; }
    body { font-family: Arial, sans-serif; margin: 2em; background: #f7f7fa; }
    .container { max-width: 880px; margin: auto; background: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 2px 8px #ccc; }
    h2 { margin-top: 0; display:flex; align-items:center; gap:.75em; }
    .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block}
    .ok{background:#22c55e}.bad{background:#ef4444}
    label { display: block; margin-top: 1em; }
    input, select, textarea, button { width: 100%; margin-top: 0.5em; padding: 0.5em; border-radius: 6px; border: 1px solid #ddd; }
    textarea { resize: vertical; }
    button { background: var(--primary); color: #fff; border: none; cursor: pointer; margin-top: 1em; }
    button:hover { background: var(--primary-dark); }
    .row { display:flex; gap:1em; }
    .row > * { flex:1; }
    .result { margin-top: 1em; background: #0b1020; color:#e6e8ef; padding: 1em; border-radius: 6px; min-height: 120px; white-space: pre-wrap; }
    .toolbar { display:flex; gap:.5em; justify-content:flex-end; margin-top:.5em; }
    .history { margin-top: 1.5em; }
    .bubble { background:#f3f4f6; border:1px solid #e5e7eb; border-radius:8px; padding:.75em; margin:.5em 0; }
    .bubble.me { background:#e0f2fe; border-color:#bae6fd; }
    .loading { display:none; align-items:center; gap:.5em; color:#555; }
    .spinner { width:16px;height:16px;border:2px solid #ddd;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite }
    @keyframes spin { to { transform: rotate(360deg) } }
    small.muted{color:#6b7280}
  </style>
</head>
<body>
  <div class="container">
    <h2>AI å¤šæ¨¡å‹æ¨ç†å¹³å° <span class="status-dot ok" id="status"></span></h2>
    <form id="ai-form" onsubmit="return false;">
      <label for="model">é€‰æ‹©æ¨¡å‹ï¼š</label>
      <select id="model" name="model"></select>
      <label for="prompt">è¾“å…¥é—®é¢˜æˆ–æŒ‡ä»¤ï¼š</label>
      <textarea id="prompt" name="prompt" rows="6" placeholder="Ctrl+Enter å¿«é€Ÿå‘é€" required></textarea>
      <div class="row">
        <div>
          <label for="temperature">Temperatureï¼ˆé‡‡æ ·æ¸©åº¦ï¼‰ï¼š</label>
          <input type="number" id="temperature" name="temperature" min="0" max="2" step="0.01" value="0.7">
        </div>
        <div>
          <label for="max_tokens">æœ€å¤§ç”Ÿæˆé•¿åº¦ï¼š</label>
          <input type="number" id="max_tokens" name="max_tokens" min="1" max="4096" step="1" value="512">
        </div>
      </div>
      <div class="row">
        <button type="submit" onclick="runInference()">æäº¤æ¨ç†</button>
        <button type="button" onclick="clearHistory()" style="background:#6b7280">æ¸…ç©ºä¼šè¯</button>
      </div>
    </form>
    <div class="loading" id="loading"><div class="spinner"></div><span>ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™â€¦</span></div>
    <div class="toolbar">
      <button type="button" onclick="copyResult()">å¤åˆ¶ç»“æœ</button>
      <button type="button" onclick="retryLast()">é‡è¯•</button>
    </div>
    <div class="result" id="result" placeholder="å°†åœ¨è¿™é‡Œæ˜¾ç¤ºå›å¤..."></div>
    <div class="history" id="history">
      <small class="muted">ä¼šè¯å†å²</small>
      <div id="history-list"></div>
    </div>
    <div class="actions">
      <button onclick="alert('è®­ç»ƒåŠŸèƒ½å¾…å¼€å‘')">AIè®­ç»ƒ</button>
      <button onclick="alert('å­¦ä¹ éƒ¨ç½²åŠŸèƒ½å¾…å¼€å‘')">å­¦ä¹ éƒ¨ç½²</button>
      <button onclick="alert('åŠŸèƒ½è”åŠ¨å¾…å¼€å‘')">åŠŸèƒ½è”åŠ¨</button>
    </div>

    <!-- AIæ¨¡å‹çŠ¶æ€é¢æ¿ -->
    <div class="ai-status-panel" style="margin-top: 2em; padding: 1em; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
      <h3 style="margin-top: 0; color: #495057;">ğŸ¤– AI å¤šæ¨¡å‹è”åŠ¨çŠ¶æ€</h3>
      <div id="ai-models-status" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1em; margin-top: 1em;">
        <!-- æ¨¡å‹çŠ¶æ€å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
      </div>
      <div id="ai-linkage-info" style="margin-top: 1em; padding: 0.5em; background: #e9ecef; border-radius: 4px; font-size: 0.9em;">
        <strong>æ¨¡å‹åŠŸèƒ½åˆ†é…ï¼š</strong><br>
        ğŸ“ qwen3:8b - ä¸­æ–‡å†…å®¹ç†è§£ä¸åˆ†æ<br>
        ğŸ§  llama3.1:8b - ä»»åŠ¡è§„åˆ’ä¸æŒ‡ä»¤ç†è§£<br>
        ğŸ¤” deepseek-r1:8b - å¤æ‚æ¨ç†ä¸å†³ç­–åˆ¶å®š<br>
        ğŸ¨ gpt-oss:20b - åˆ›æ„ç”Ÿæˆä¸æ–‡æœ¬ä¼˜åŒ–
      </div>
    </div>
  </div>
  <script>
    // å¥åº·çŠ¶æ€
    async function checkHealth(){
      const dot = document.getElementById('status');
      try{
        const r = await fetch('/health'); await r.json();
        dot.classList.remove('bad'); dot.classList.add('ok');
        document.title = 'AI å¤šæ¨¡å‹æ¨ç†å¹³å° Â· åœ¨çº¿';
      }catch{ dot.classList.remove('ok'); dot.classList.add('bad'); document.title = 'AI å¤šæ¨¡å‹æ¨ç†å¹³å° Â· ç¦»çº¿'; }
    }
    setInterval(checkHealth, 8000); checkHealth();

    // åŠ¨æ€è·å–æ¨¡å‹åˆ—è¡¨
    async function loadModels() {
      try {
        const resp = await fetch('/models');
        const data = await resp.json();
        if (data.status === 'success') {
          const sel = document.getElementById('model');
          sel.innerHTML = '';
          const last = localStorage.getItem('model') || data.result[0];
          data.result.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m; opt.textContent = m;
            if(m===last) opt.selected = true;
            sel.appendChild(opt);
          });
        }
      } catch (e) { console.error('æ¨¡å‹åˆ—è¡¨è·å–å¤±è´¥', e); }
    }
    loadModels();

    // æ¨ç†è¯·æ±‚
    async function runInference() {
      const btns = document.querySelectorAll('button');
      const model = document.getElementById('model').value;
      const prompt = document.getElementById('prompt').value;
      const temperature = parseFloat(document.getElementById('temperature').value);
      const max_tokens = parseInt(document.getElementById('max_tokens').value);
      if(!prompt.trim()) return;
      localStorage.setItem('model', model);
      document.getElementById('loading').style.display='flex';
      btns.forEach(b=>b.disabled=true);
      try {
        const resp = await fetch('/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model, prompt, temperature, max_tokens })
        });
        const data = await resp.json();
        if (data.status === 'success') {
          document.getElementById('result').textContent = data.result;
          pushHistory(prompt, data.result, model);
        } else {
          document.getElementById('result').textContent = 'é”™è¯¯ï¼š' + data.result;
        }
      } catch (e) {
        document.getElementById('result').textContent = 'è¯·æ±‚å¤±è´¥ï¼š' + e;
      }
      document.getElementById('loading').style.display='none';
      btns.forEach(b=>b.disabled=false);
      window._last = {model, prompt, temperature, max_tokens};
    }

    // å†å²è®°å½•
    function pushHistory(q, a, model){
      const area = document.getElementById('history-list');
      const me = document.createElement('div');
      me.className='bubble me'; me.textContent = 'æˆ‘ï¼š'+q;
      const bot = document.createElement('div');
      bot.className='bubble'; bot.textContent = '['+model+'] '+a;
      area.appendChild(me); area.appendChild(bot);
      area.scrollTop = area.scrollHeight;
    }

    function clearHistory(){
      document.getElementById('history-list').innerHTML='';
      document.getElementById('result').textContent='';
    }

    // å¤åˆ¶ç»“æœ
    async function copyResult(){
      const text = document.getElementById('result').textContent || '';
      if(!text) return;
      try{ await navigator.clipboard.writeText(text); alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'); }catch{ alert('å¤åˆ¶å¤±è´¥'); }
    }

    // é‡è¯•æœ€åä¸€æ¬¡
    async function retryLast(){
      if(window._last){
        document.getElementById('prompt').value = window._last.prompt;
        await runInference();
      }
    }

    // Ctrl+Enter å¿«æ·å‘é€
    document.getElementById('prompt').addEventListener('keydown', (e)=>{
      if(e.ctrlKey && e.key === 'Enter'){ runInference(); }
    });

    // AIæ¨¡å‹çŠ¶æ€æ£€æŸ¥
    async function checkAIStatus(){
      try {
        const resp = await fetch('/ai/status');
        const data = await resp.json();
        if (data.status === 'ok') {
          updateAIModelsStatus(data.models, data.model_linkage);
        } else {
          console.error('AIçŠ¶æ€è·å–å¤±è´¥:', data.msg);
        }
      } catch (e) {
        console.error('AIçŠ¶æ€æ£€æŸ¥å¤±è´¥:', e);
      }
    }

    function updateAIModelsStatus(models, linkage) {
      const container = document.getElementById('ai-models-status');
      container.innerHTML = '';

      const modelEmojis = {
        'qwen3:8b': 'ğŸ“',
        'llama3.1:8b': 'ğŸ§ ',
        'deepseek-r1:8b': 'ğŸ¤”',
        'gpt-oss:20b': 'ğŸ¨'
      };

      for (const [model, status] of Object.entries(models)) {
        const modelCard = document.createElement('div');
        modelCard.style.cssText = `
          padding: 0.75em;
          border: 1px solid #dee2e6;
          border-radius: 6px;
          background: white;
          text-align: center;
        `;

        const emoji = modelEmojis[model] || 'ğŸ¤–';
        const statusColor = status === 'online' ? '#28a745' : '#dc3545';
        const statusText = status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿';

        modelCard.innerHTML = `
          <div style="font-size: 1.5em; margin-bottom: 0.5em;">${emoji}</div>
          <div style="font-weight: bold; margin-bottom: 0.25em;">${model}</div>
          <div style="color: ${statusColor}; font-size: 0.9em;">${statusText}</div>
          <div style="font-size: 0.8em; color: #6c757d; margin-top: 0.25em;">${linkage[model] || 'å¾…åˆ†é…'}</div>
        `;

        container.appendChild(modelCard);
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥AIçŠ¶æ€
    checkAIStatus();
    // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡AIçŠ¶æ€
    setInterval(checkAIStatus, 30000);
  </script>
</body>
</html>
