<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>AI ä¼˜åŒ–ç»“æœä¸äº¤äº’æ§åˆ¶å°</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    .pending { color: orange; }
    .optimized { color: green; }
    .rollback { color: red; }
    pre { background: #f6f6f6; padding: 1em; border-radius: 4px; }
    button { margin: 0.2em 0.5em; }
  </style>
</head>
<body>
  <h1>AI ä¼˜åŒ–ç»“æœä¸äº¤äº’æ§åˆ¶å°</h1>
  <div>
    <button onclick="triggerOptimize()">ç«‹å³ä¼˜åŒ–</button>
    <button onclick="triggerSchedule()">å®šæ—¶ä¼˜åŒ–(æ¯å°æ—¶)</button>
    <button onclick="triggerOnChange()">å˜æ›´è§¦å‘</button>
    <button onclick="stopSchedule()">åœæ­¢å®šæ—¶</button>
    <span id="status"></span>
  </div>
  <h2>ä¼˜åŒ–ç»“æœ</h2>
  <div id="results"></div>

  <!-- AIå¢å¼ºç»“æœé¢æ¿ -->
  <h2>ğŸ¤– AI å¤šæ¨¡å‹è”åŠ¨åˆ†æ</h2>
  <div id="ai-enhanced-results" style="margin-top: 1em;"></div>

  <script>
    async function fetchResults() {
      const res = await fetch('http://localhost:9001/results');
      const data = await res.json();
      const resultsDiv = document.getElementById('results');
      const aiResultsDiv = document.getElementById('ai-enhanced-results');

      if (!data.items || !data.items.length) {
        resultsDiv.innerHTML = '<em>æš‚æ— ä¼˜åŒ–è®°å½•</em>';
        aiResultsDiv.innerHTML = '<em>æš‚æ— AIåˆ†æç»“æœ</em>';
        return;
      }

      // åŸºç¡€ç»“æœæ˜¾ç¤º
      resultsDiv.innerHTML = data.items.map(item => {
        let color = item.status;
        let btn = '';
        if (item.status === 'pending_approval') {
          btn = `<button onclick=\"approve('${item.file}')\">å®¡æ‰¹é€šè¿‡</button>`;
        }

        // AIå¢å¼ºæ ‡è¯†
        let aiBadge = '';
        if (item.ai_enhanced) {
          aiBadge = '<span style="background:#0078d7;color:white;padding:2px 6px;border-radius:3px;font-size:0.8em;margin-left:0.5em;">AIå¢å¼º</span>';
        }

        return `<div class='${color}'><b>${item.file}</b> çŠ¶æ€: <span>${item.status}</span> ${aiBadge} ${btn}<br>` +
          (item.stages ? `<details><summary>è¯¦æƒ…</summary><pre>${JSON.stringify(item.stages, null, 2)}</pre></details>` : '') +
          `</div>`;
      }).join('<hr>');

      // AIå¢å¼ºç»“æœæ˜¾ç¤º
      const aiEnhancedItems = data.items.filter(item => item.ai_enhanced);
      if (aiEnhancedItems.length > 0) {
        aiResultsDiv.innerHTML = aiEnhancedItems.map(item => {
          const analysis = item.ai_analysis || {};
          return `
            <div style="border:1px solid #ddd; border-radius:6px; padding:1em; margin:0.5em 0; background:#f9f9f9;">
              <h4 style="margin-top:0; color:#0078d7;">ğŸ“„ ${item.file}</h4>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:1em;">
                <div>
                  <strong>AIåˆ†æç»“æœ:</strong><br>
                  <pre style="background:white; padding:0.5em; border-radius:4px; margin-top:0.5em; font-size:0.9em;">${JSON.stringify(analysis, null, 2)}</pre>
                </div>
                <div>
                  <strong>ä¼˜åŒ–å»ºè®®:</strong><br>
                  <div style="background:white; padding:0.5em; border-radius:4px; margin-top:0.5em;">
                    ${analysis.recommendations ? analysis.recommendations.map(rec => `â€¢ ${rec}`).join('<br>') : 'æš‚æ— å»ºè®®'}
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      } else {
        aiResultsDiv.innerHTML = '<em>æš‚æ— AIå¢å¼ºåˆ†æç»“æœ</em>';
      }

      // æ˜¾ç¤ºAIæ¨¡å‹ä½¿ç”¨æƒ…å†µ
      if (data.ai_models_used) {
        const modelsInfo = Object.entries(data.ai_models_used).map(([model, status]) => {
          const statusColor = status === 'online' ? '#28a745' : '#dc3545';
          return `<span style="color:${statusColor};">${model}: ${status}</span>`;
        }).join(', ');

        aiResultsDiv.innerHTML += `
          <div style="margin-top:1em; padding:0.5em; background:#e9ecef; border-radius:4px;">
            <strong>AIæ¨¡å‹çŠ¶æ€:</strong> ${modelsInfo}
          </div>
        `;
      }
    }
    async function triggerOptimize() {
      setStatus('æ­£åœ¨è§¦å‘ä¼˜åŒ–...');
      await fetch('http://localhost:9001/trigger', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({auto_approve:true})});
      setStatus('å·²è§¦å‘ä¼˜åŒ–');
      setTimeout(fetchResults, 2000);
    }
    async function triggerSchedule() {
      setStatus('å·²å¯åŠ¨å®šæ—¶ä¼˜åŒ–(æ¯å°æ—¶)');
      await fetch('http://localhost:9001/trigger/schedule', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({interval:3600,auto_approve:true})});
    }
    async function stopSchedule() {
      setStatus('å·²è¯·æ±‚åœæ­¢å®šæ—¶');
      await fetch('http://localhost:9001/trigger/stop', {method:'POST'});
    }
    async function triggerOnChange() {
      setStatus('å·²å¯åŠ¨å˜æ›´è§¦å‘');
      await fetch('http://localhost:9001/trigger/onchange', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({watch_dir:"./",interval:10,auto_approve:true})});
    }
    async function approve(file) {
      setStatus('æ­£åœ¨å®¡æ‰¹...');
      await fetch('http://localhost:9001/approve', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({file})});
      setStatus('å·²å®¡æ‰¹');
      setTimeout(fetchResults, 2000);
    }
    function setStatus(msg) {
      document.getElementById('status').innerText = msg;
    }
    setInterval(fetchResults, 5000);
    fetchResults();
  </script>
</body>
</html>
